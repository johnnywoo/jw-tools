#!/bin/bash

set -e

folder=/Volumes/vps
host="agalkin.vps.loc"
share="//www:brjrfrjkf@$host/sites/"

if [ -d "$folder" ] && [ -z "`ls $folder`" ]
then
	echo "Removing empty directory"
	rm -rf "$folder"
fi

case $1 in
"u")
	if [ -e "$folder" ]
	then
		echo "Unmounting"
		umount "$folder"
		# we have to wait while umount is working in background
		while [ -e "$folder" ]; do
			sleep 0.2
		done
	else
		echo "Not mounted"
	fi
	exit
	;;
esac

if [ -e "$folder" ]
then
	echo "Already mounted" 1>&2
	echo "To unmount: $0 u" 1>&2
	exit 1
fi

while ! `ping -o -t 1 $host >/dev/null 2>&1`
do
	echo "Cannot reach $host" >&2
	sleep 1
done

echo "Mounting in writeable mode"

mkdir "$folder"
mount_smbfs "$share" "$folder"
